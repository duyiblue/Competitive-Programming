# CF1097E Egor and an RPG game

[题目链接](https://codeforces.com/contest/1097/problem/E)

---

约定：以下称一个单调上升或单调下降的子序列，为“合法子序列”。称最长上升子序列为 $\text{LIS}$，最长下降子序列为 $\text{LDS}$。

---

考虑 $f(n)$ 是多少。

我们想办法构造出一个“划分出的合法子序列数”很大的排列。考虑如下序列：
$$
\{1, 3, 2, 6, 5, 4, 10, 9, 8, 7, \dots \}
$$
即，它是**分层上升**的，每层比上一层多一个数，且同一层内是严格递减的。

当存在某个正整数 $k$，满足 $n = 1 + 2 + \dots + k = \frac{k(k + 1)}{2}$ 时，这个序列无论划分成上升还是下降，都至少要分出 $k$ 个合法子序列。更进一步，如果 $\frac{k(k + 1)}{2}\leq n < \frac{(k + 1)(k + 2)}{2}$，则用类似的构造方法，也可以使得一个长度为 $n$ 的序列，**至少**分出 $k$ 个合法子序列。换句话说，现在我们说明了：
$$
f(n)\geq \max\left\{k \ \bigg |\ \frac{k(k + 1)}{2} \leq n\right\}
$$

记 $c(n) = \max\left\{k \ \big |\ \frac{k(k + 1)}{2} \leq n\right\}$。

现在，如果我们能够想到一种方法，使得对任意长度为 $n$ 的排列，都能将它划分为不超过 $c(n)$ 个合法的子序列，我们的任务就完成了。因为：我们划分出的子序列数 $\leq c(n)$，而 $c(n)\leq f(n)$。

用归纳法。假设命题【**对任意 $k  \geq c(m)$，总能把一个长度为 $m$ 的排列划分为不超过 $k$ 个合法子序列**】在 $1\leq m < n$ 时成立。接下来我们证明它在 $m = n$ 时也是成立的。

求出当前序列的一个 $\text{LIS}$，记它的长度为 $l$。

**情况一**：若 $l > c(n)$，则将它作为新划分出的一个子序列，加入答案。之后问题规模缩减为：
$$
k' \gets k - 1\\
n' \gets n - l
$$
对原来的 $n, k$，我们有：$n < \frac{(k + 1)(k + 2)}{2}$。发现删除后，$n - l < \frac{(k + 1)(k + 2)}{2} - (k + 1)= \frac{k(k + 1)}{2}$，即 $n' < \frac{(k' + 1)(k' + 2)}{2}$。所以 $c(n')\leq k'$。此时根据归纳假设，可知原命题成立。

**情况二**：若 $l \leq c(n)$。发现我们总能将原序列划分为恰好 $l$ 个下降子序列。其实就是在用二分求 $\text{LIS}$ 的算法中，每次二分出第一个大于当前数的位置后，不直接覆盖，而是把当前数加入到它代表的下降子序列中。具体可以见代码。

综上所述，原命题成立。因此用上述方法构造出的划分方案，就是符合要求的答案了。另外，上述的构造顺便还说明了 $f(n)\leq c(n)$，进而 $f(n) = c(n)$，不过这已经不重要了。

每次找 $\text{LIS}$ 是 $\mathcal{O}(n\log n)$ 的（我用的树状数组）。因为 $c(n)$ 是 $\mathcal{O}(\sqrt{n})$ 级别的，所以总时间复杂度 $\mathcal{O}(n\sqrt{n}\log n)$。

[参考代码-在CF查看](https://codeforces.com/contest/1097/submission/107106209)

---

**总结**：

我们先想方设法，构造出了一个“划分出的合法子序列数”很大的排列，从而确定了 $f(n)$ 的一个下界 $c(n)$。接下来我们通过归纳地构造，使得对任意长度为 $n$ 的排列，都能划分出不超过 $c(n)$ 个合法子序列。

构造的过程中，还用到了 $\text{dilworth}$ 定理的一个推论：如果原序列的 $\text{LIS}$ 长度为 $l$，那么它能被划分为 $l$ 个下降子序列（而且不能再少了）。

**归类**：归纳。

**难度**：难。

